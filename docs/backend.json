{
  "entities": {
    "Product": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Product",
      "type": "object",
      "description": "Represents a product in the Atelier Luxe catalog.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Product entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the product."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the product."
        },
        "price": {
          "type": "number",
          "description": "The price of the product."
        },
        "imageUrl": {
          "type": "string",
          "description": "URL of the product's main image."
        },
        "category": {
          "type": "string",
          "description": "The category the product belongs to (e.g., Men's Clothing, Women's Clothing)."
        },
        "additionalImageUrls": {
          "type": "array",
          "description": "URLs of additional images for the product.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "price",
        "imageUrl",
        "category"
      ]
    },
    "Review": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Review",
      "type": "object",
      "description": "Represents a review for a product.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Review entity."
        },
        "productId": {
          "type": "string",
          "description": "Reference to Product. (Relationship: Product 1:N Review)"
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N Review)"
        },
        "rating": {
          "type": "number",
          "description": "The rating given in the review (e.g., 1 to 5)."
        },
        "comment": {
          "type": "string",
          "description": "The text of the review."
        },
        "date": {
          "type": "string",
          "description": "The date the review was submitted.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "productId",
        "userId",
        "rating",
        "comment",
        "date"
      ]
    },
    "CartItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CartItem",
      "type": "object",
      "description": "Represents an item in the shopping cart.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CartItem entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N CartItem)"
        },
        "productId": {
          "type": "string",
          "description": "Reference to Product. (Relationship: Product 1:N CartItem)"
        },
        "quantity": {
          "type": "number",
          "description": "The quantity of the product in the cart."
        }
      },
      "required": [
        "id",
        "userId",
        "productId",
        "quantity"
      ]
    },
    "Order": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Order",
      "type": "object",
      "description": "Represents an order placed by a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Order entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N Order)"
        },
        "orderDate": {
          "type": "string",
          "description": "The date the order was placed.",
          "format": "date-time"
        },
        "totalAmount": {
          "type": "number",
          "description": "The total amount of the order."
        },
        "status": {
          "type": "string",
          "description": "The status of the order (e.g., pending, processing, shipped, completed)."
        },
        "orderItemIds": {
          "type": "array",
          "description": "References to OrderItem. (Relationship: Order 1:N OrderItem)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "userId",
        "orderDate",
        "totalAmount",
        "status"
      ]
    },
    "OrderItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "OrderItem",
      "type": "object",
      "description": "Represents an item within an order.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the OrderItem entity."
        },
        "orderId": {
          "type": "string",
          "description": "Reference to Order. (Relationship: Order 1:N OrderItem)"
        },
        "productId": {
          "type": "string",
          "description": "Reference to Product. (Relationship: Product 1:N OrderItem)"
        },
        "quantity": {
          "type": "number",
          "description": "The quantity of the product in this order item."
        },
        "price": {
          "type": "number",
          "description": "The price of the product at the time of the order."
        }
      },
      "required": [
        "id",
        "productId",
        "quantity",
        "price",
        "orderId"
      ]
    },
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents user profile information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "The user's first name."
        },
        "lastName": {
          "type": "string",
          "description": "The user's last name."
        },
        "address": {
          "type": "string",
          "description": "The user's address."
        },
        "phoneNumber": {
          "type": "string",
          "description": "The user's phone number."
        },
        "favoriteProductIds": {
          "type": "array",
          "description": "References to Products. (Relationship: UserProfile N:N Product (favorites))",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/products/{productId}",
        "definition": {
          "entityName": "Product",
          "schema": {
            "$ref": "#/backend/entities/Product"
          },
          "description": "Stores product information. Accessible to all users for reading.",
          "params": [
            {
              "name": "productId",
              "description": "The unique identifier for the product."
            }
          ]
        }
      },
      {
        "path": "/products/{productId}/reviews/{reviewId}",
        "definition": {
          "entityName": "Review",
          "schema": {
            "$ref": "#/backend/entities/Review"
          },
          "description": "Stores reviews for each product. Anyone can create a review for any product, but listing reviews is open.",
          "params": [
            {
              "name": "productId",
              "description": "The unique identifier for the product."
            },
            {
              "name": "reviewId",
              "description": "The unique identifier for the review."
            }
          ]
        }
      },
      {
        "path": "/userProfiles/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information. Only the authenticated user can read/write their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user. Must match auth.uid."
            }
          ]
        }
      },
      {
        "path": "/userProfiles/{userId}/orders/{orderId}",
        "definition": {
          "entityName": "Order",
          "schema": {
            "$ref": "#/backend/entities/Order"
          },
          "description": "Stores order information for each user. Only the authenticated user can read/write their own orders.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user. Must match auth.uid."
            },
            {
              "name": "orderId",
              "description": "The unique identifier for the order."
            }
          ]
        }
      },
      {
        "path": "/userProfiles/{userId}/orders/{orderId}/orderItems/{orderItemId}",
        "definition": {
          "entityName": "OrderItem",
          "schema": {
            "$ref": "#/backend/entities/OrderItem"
          },
          "description": "Stores order items for each order. Only the authenticated user can read/write their own order items.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user. Must match auth.uid."
            },
            {
              "name": "orderId",
              "description": "The unique identifier for the order."
            },
            {
              "name": "orderItemId",
              "description": "The unique identifier for the order item."
            }
          ]
        }
      },
      {
        "path": "/cartItems/{cartItemId}",
        "definition": {
          "entityName": "CartItem",
          "schema": {
            "$ref": "#/backend/entities/CartItem"
          },
          "description": "Stores cart items for each user.  The 'userId' field within the document data MUST match the document ID.  This enforces that only the user owning a specific cart item can access/modify it.",
          "params": [
            {
              "name": "cartItemId",
              "description": "The unique identifier for the cart item.  This should match the userId to enforce ownership."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support an e-commerce application ('Atelier Luxe') with a focus on user authentication and order management. Key considerations include protecting order submissions to authenticated users and enabling product browsing for guests. The structure prioritizes authorization independence and clear access control. Products are stored in a flat `products` collection. User profiles are stored in a dedicated `userProfiles` collection, which enables authenticated-only write access to user-specific data. Orders are placed in a subcollection under each user's profile (`userProfiles/{userId}/orders`), ensuring that only the authenticated user can create or view their orders. Order items are stored in a subcollection under each order (`userProfiles/{userId}/orders/{orderId}/orderItems`). Reviews are stored in a subcollection under each product (`products/{productId}/reviews`). This design ensures proper data segregation and aligns with the principle of homogeneous security posture.\n\n**Authorization Independence:** The `orders` and `orderItems` subcollections under `userProfiles/{userId}` achieve authorization independence. The security rules only need to verify the `userId` in the path against `request.auth.uid`, without needing to fetch any parent document data.  Similarly, `reviews` are nested under `products` without authorization dependencies, as any user can create a review.\n\n**QAPs (Rules are not Filters):** The structure enables secure `list` operations.  Listing products is open to all, and listing orders is restricted to the authenticated user via the path-based ownership model (`/userProfiles/{userId}/orders`). This structure also ensures that security rules do not act as filters, as the data is already segregated based on access control requirements."
  }
}